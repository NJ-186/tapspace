<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>videograph - Tapspace Example</title>

  <!--
    Vimeo Graph Browser

    In this example we implement a graph browser for Vimeo videos.
  -->

  <!-- Disable user scalability to override native touch gestures. -->
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    html, body, #space {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: black;
      color: white;
      font-family: sans-serif;
    }
  </style>
</head>
<body>
  <div id="space"></div>

  <script src="../assets/ghoulog.js"></script>
  <script src="https://unpkg.com/tapspace@1.3.0/dist/tapspace.min.js"></script>

  <script>

    // Methods for connecting Vimeo API

    var TOKEN = 'OWY4NTQxMDNkNWFjYTQwMDZkMzU3YzFhNDZjODg2NTZlN2M3MmFjZjpJVz' +
      'RIRmt1a3VuSGY2dmw0d1VaL1JVcWEzNFJuc2p2RGJKWDlsemVQQ2xMNlhieEVjR3F0Um' +
      'dZSjNIcmtNSGJNR3JnU1dVRDRrU3pOdWlmem1mdW54dkgrQ29MQ0RiZm1ZN1U5b0laeG' +
      '9yVmpRUS9PZDhvTTUxVk92N1ZHekRURA=='

    var getVimeoAccessToken = function (callback) {
      var xhr = new XMLHttpRequest()

      xhr.addEventListener('load', function () {
        if (xhr.status === 200) {
          var resp = JSON.parse(xhr.responseText)
          return callback(resp)
        }
        console.log(xhr)
        throw new Error('Failed')
      })

      xhr.open('POST', 'https://api.vimeo.com/oauth/authorize/client')
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
      xhr.setRequestHeader('Authorization', 'basic ' + TOKEN)
      xhr.send(encodeURI('grant_type=client_credentials'))
    }

    var getVimeoVideo = function (id, accessToken, callback) {
      var xhr = new XMLHttpRequest()

      xhr.addEventListener('load', function () {
        if (xhr.status === 200) {
          return callback(JSON.parse(xhr.responseText))
        }
        console.error(xhr)
      })

      var url = 'https://api.vimeo.com/videos/' + id + '?' +
        'access_token=' + accessToken

      xhr.open('GET', url)
      xhr.send()
    }

    var getVimeoRelated = function (id, accessToken, callback) {
      var NUM = 2
      var xhr = new XMLHttpRequest()

      xhr.addEventListener('load', function () {
        if (xhr.status === 200) {
          return callback(JSON.parse(xhr.responseText))
        }
        console.error(xhr)
      })

      var url = 'https://api.vimeo.com/videos/' + id + '/videos?' +
        'filter=related&page=1&per_page=' + NUM + '&' +
        'access_token=' + accessToken

      xhr.open('GET', url)
      xhr.send()
    }

    var getVimeoVideoId = function (videodata) {
      var parts = videodata.uri.split('/')
      return parts[parts.length - 1]
    }

    var getVimeoImageLiteral = function (videodata) {
      var s = videodata.pictures.sizes[2]
      return {
        src: s.link,
        width: s.width,
        height: s.height
      }
    }

    var getVimeoIframeTag = function (videodata) {
      var id = getVimeoVideoId(videodata)
      var img = getVimeoImageLiteral(videodata)
      var w = img.width
      var h = img.height
      return '<iframe type="text/html" ' +
        'width="' + w + '" height="' + h + '" frameborder="0" ' +
        'src="https://player.vimeo.com/video/' + id + '" ' +
        'webkitallowfullscreen mozallowfullscreen allowfullscreen ' +
        '></iframe>'
    }

    var SpaceVideo = function (view, videodata) {
      var data = videodata
      var videoId = getVimeoVideoId(data)
      var relateddata = null
      var group = null
      var simg = null
      var shtml = null

      this.init = function (parentItem, pivotItem, childIndex) {
        // Require view and parent SpaceVideo.
        // Optional pivot IVector and childIndex number.
        // Group for title, thumbnail and player
        group = new tapspace.SpaceGroup(parentItem)
        var imglit = getVimeoImageLiteral(data)
        // Show thumbnail initially
        simg = new tapspace.SpaceImage(imglit, group)

        // Position. The first item does not need positioning.
        if (pivotItem && typeof childIndex === 'number') {
          var parentWidth = pivotItem.getISize().getWidth()
          var myWidth = parentWidth.multiply(0.618)
          var myHalf = myWidth.multiply(0.5)
          var radius = parentWidth.multiply(1.2).subtract(myHalf)
          var radiusmax = radius.add(myWidth)
          var angle = childIndex * Math.PI / 6 - Math.PI / 4
          var pivot = pivotItem.atMid()
          group.translateScaleRotate(
            [simg.atMidW(), simg.atMidE()],
            [
              pivot.polarOffset(radius, angle, pivotItem),
              pivot.polarOffset(radiusmax, angle, pivotItem)
            ]
          )
        }

        var tapper = new tapspace.Touchable(view, simg)
        tapper.start({ tap: true, preventDefault: false })
      }

      this.destroy = function () {
        item.remove()
      }

      this.getImage = function () {
        if (simg) {
          return simg
        }
        throw new Error('simg is null. Try to init SpaceVideo first.')
      }

      this.getGroup = function () {
        // To be the parent of the next
        if (group) {
          return group
        }
        throw new Error('Group is null. Try init the SpaceVideo first.')
      }

      this.atMid = function () {
        return simg.atMid()
      }

      this.openPlayer = function () {
        var html = getVimeoIframeTag(data)
        shtml = new tapspace.SpaceHTML(html)
        item.addChild(shtml)
        shtml.translateScaleRotate(
          [shtml.atNW(), shtml.atNE()],
          [simg.atNW(), simg.atNE()]
        )
      }

      this.closePlayer = function () {
        if (shtml) {
          shtml.remove()
        }
      }

      this.openLeaves = function (accessToken, cb) {
        var self = this

        if (group === null || simg === null) {
          throw new Error('Group is null. Call SpaceItem#init first.')
        }

        if (relateddata === null) {
          getVimeoRelated(videoId, accessToken, function (res) {
            // console.log('related success', res3)
            relateddata = res
            self.openLeaves(accessToken, cb)
          })

          return
        }

        var leaves = relateddata.data.map(function (relvid, i) {
          var child = new SpaceVideo(view, relvid)
          child.init(group, simg, i)
          return child
        })

        return cb(leaves)
      }

      this.closeLeaves = function () {

      }
    }

    // Tapspace

    var debugSV = function (svideo) {
      console.log(svideo.getImage().atMid().toSpace().toArray())
    }

    var space = new tapspace.Space()
    var view = new tapspace.SpaceView(space)
    view.mount(document.getElementById('space'))

    var viewtouch = new tapspace.Touchable(view, view)
    var viewwheel = new tapspace.Wheelable(view, view)
    viewwheel.start({ scale: true })
    viewtouch.start({ translate: true, scale: true })

    var videos = new tapspace.SpaceGroup(space)

    getVimeoAccessToken(function (res) {
      // console.log('access success', res)
      var accessToken = res.access_token

      var videoId = '257871741'
      getVimeoVideo(videoId, accessToken, function (res2) {
        console.log('video success', res2)

        var svid = new SpaceVideo(view, res2)
        svid.init(videos)

        debugSV(svid)

        svid.openLeaves(accessToken, function (leaves) {
          leaves.forEach(function (leafSV) {
            debugSV(leafSV)
            leafSV.openLeaves(accessToken, function (leaves2) {
              leaves2.forEach(function (l) {
                debugSV(l)
              })
            })
          })

          view.fitScale(videos)
        })
      })
    })
  </script>
</body>
</html>
